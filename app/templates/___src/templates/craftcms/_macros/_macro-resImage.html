{# Set Attributes
  {% set options = {
    image: IMAGE_ELEMENT,
    class: 'm-figure',
    sizes: [
      { width: 1680 },
      { width: 960 },
      { width: 480 }
    ],
    background: false,
    quality: 80,
    mode: 'crop',
    position: '50% 50%',
    ratio: IMAGE_ELEMENT_RATIO,
    caption: IMAGE_ELEMENT_CAPTION,
    dominantColor: true,
    effects: { grayscale: true },
  } %}

  macroResImage.resImage(options)
#}

{% macro resImage(image,options) %}

  {# Set Defaults #}
  {% set defaults = {
  class: 'm-figure',
  sizes: [
  { width: 1680 },
  { width: 960 },
  { width: 480 }
  ],
  background: false,
  elementtype: 'figure',
  quality: 80,
  mode: 'crop',
  position: false,
  ratio: false,
  caption: false,
  dominantColor: false,
  effects: {},
  } %}

  {# Merge Attr with Defaults #}
  {% set options = options ? defaults|merge(options) : defaults %}

  {% if image %}
    {# Set Ratio #}
    {% if options.ratio %}
      {% set ratio = options.ratio|split(':') %}
      {% set base64Ratio = options.ratio|split(':') %}
      {% set ratio = ratio|first/ratio|last %}
    {% else %}
      {% set imageSize = options.image.width ~ ':' ~ options.image.height %}
      {% set base64Ratio = imageSize|split(':') %}
      {% set ratio = '' %}
    {% endif %}

    {# Set Position #}
    {% if options.position %}
      {% set position = options.position %}
    {% elseif options.image.settingsFocalPoint %}
      {% set position = options.image.settingsFocalPoint %}
    {% else %}
      {% set position = '50% 50%' %}
    {% endif %}

    {# Define global variables #}
    {% set imageSettings = {
      jpegQuality: options.quality,
      mode: options.mode,
      position: position,
      ratio: ratio,
      effects: options.effects
    } %}

    {# Image #}
    {% set images = craft.imager.transformImage(options.image, options.sizes, imageSettings) %}

    {# Set Dominant Color #}
    {% if options.dominantColor %}
      {% set dominantColor = options.dominantColor %}
    {% elseif options.dominantColor %}
      {% set dominantColor = craft.imager.getDominantColor(images|last, 20) %}
    {% else %}
      {% set dominantColor = '' %}
    {% endif %}

    {% if options.background %}
      <{{ options.elementtype }} class="{{ options.ratio ? 'o-ratio  o-ratio--' ~ options.ratio : '' }}  {{ options.class }}  lazyload"
      style="background-image: url('{{ craft.imager.base64Pixel(base64Ratio|first, base64Ratio|last) }}');
      background-position: {{ position }};
      {{ not options.ratio ? 'padding-bottom:' ~ images[0].height / images[0].width * 100 ~ '%;' : '' }}
      {{ dominantColor ? 'background-color:' ~  dominantColor ~ ';': '' }}"
      data-bgset="{{ craft.imager.srcset(images) }}"
      data-sizes="auto">
      </{{ options.elementtype }}>

    {% else %}
      <figure class="{{ options.class }}"
              style="{{ dominantColor ? 'background-color:' ~  dominantColor ~ ';': '' }}">
        <img class="lazyload  {{ options.class ~ '__image' }}"
             src="{{ images|last.url }}"
             srcset="{{ craft.imager.base64Pixel(base64Ratio|first, base64Ratio|last) }}"
             data-srcset="{{ craft.imager.srcset(images) }}"
             data-sizes="auto"
             alt="{{ options.image.title }}"/>
        {% if options.caption %}
          <figcaption>
            {{ options.caption|raw }}
          </figcaption>
        {% endif %}
      </figure>

    {% endif %}
  {% endif %}
{% endmacro %}
